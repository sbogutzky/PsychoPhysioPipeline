---
title: "Flow beim Laufen (intraindividell)"
author: "Simon Bogutzky"
date: "25. Februar 2016"
output: html_document
---

# Rohdaten

```{r plot-raw-data}

# Remove all variables
rm(list = ls(all = T))

# Set working directory
setwd("~/psychophysiopipeline/report")

# Load library
library("flow", "tikzDevice")

# Set directories
preprocessed.data.directory <- "preprocessed/"
activity.directory <- "laufen/"
user.directory <- "buse-patrick/"
date.directory <- "2013-10-31--18-31-19/"
kinematic.data.file.name <- "imu-rn42-3b70-3.csv"
mid.swing.data.file.name <- "imu-rn42-3b70-mid-swing-indexes-3.csv"
ecg.data.file.name <- "imu-rn42-bd38-3.csv"
kubios.hrv.data.file.name <- "imu-rn42-bd38-3_hrv.txt"

# Set paths
root.path <- "C:/Users/sbogutzky/Desktop/data (lokal)/2013/"
kinematic.data.path <- paste(root.path, preprocessed.data.directory, activity.directory, user.directory, date.directory, kinematic.data.file.name, sep = "")
mid.swing.data.path <- paste(root.path, preprocessed.data.directory, activity.directory, user.directory, date.directory, mid.swing.data.file.name, sep = "")
ecg.data.file.path <- paste(root.path, preprocessed.data.directory, activity.directory, user.directory, date.directory, ecg.data.file.name, sep = "")
kubios.hrv.data.file.path <- paste(root.path, preprocessed.data.directory, activity.directory, user.directory, date.directory, kubios.hrv.data.file.name, sep = "")
    
# Load kinematic and midswing data
kinematic.data <- read.csv(kinematic.data.path)
mid.swing.data <- read.csv(mid.swing.data.path)
ecg.data <- read.csv(ecg.data.file.path)

# Load source to load kubios hrv time data
source("../preprocessing/code-snippets/read-kubios-hrv-data.R")

tikz("5-2-daten.tex", width = 7.91, height = 5.22, standAlone = TRUE)

par(mai = c(.8, .8, .1, .1), mgp = c(2.5, 1, 0), mfcol = c(2, 4))

n <- 200
y <- ecg.data[ecg.data[, 1] > mid.swing.data[n, 1] & ecg.data[, 1] < mid.swing.data[n + 1, 1], 2]
x.p <- 1:length(y) / length(y) * 100
plot(x.p, y, type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "EKG RA-LL ($mV$)", ylim = c(-3, 3), xaxs = "i")
grid(col = rgb(186/255, 187/255, 194/255))
box()

y <- ecg.data[ecg.data[, 1] > mid.swing.data[n, 1] & ecg.data[, 1] < mid.swing.data[n + 1, 1], 3]
plot(x.p, y, type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "EKG LA-LL ($mV$)", ylim = c(-3, 3), xaxs = "i")
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 2], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
x.p <- 1:length(y) / length(y) * 100
plot(x.p, -c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Beschleunigung Y ($m/s^2$)", ylim = c(-30, 30), xaxs = "i", col = rgb(155/255, 193/255, 54/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 5], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
plot(x.p, -c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Winkelgeschwindigkeit X ($deg/s$)", ylim = c(-600, 600), xaxs = "i", col = rgb(155/255, 193/255, 54/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 3], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
plot(x.p, c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Beschleunigung Y ($m/s^2$)", ylim = c(-30, 30), xaxs = "i", col = rgb(0/255, 152/255, 199/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 6], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
plot(x.p, c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Winkelgeschwindigkeit Y ($deg/s$)", ylim = c(-600, 600), xaxs = "i", col = rgb(0/255, 152/255, 199/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 4], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
plot(x.p, -c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Beschleunigung Z ($m/s^2$)", ylim = c(-30, 30), xaxs = "i", col = rgb(229/255, 66/255, 66/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

most.common.cycle.matrix <- ComputeMostCommonCycleMatrix(kinematic.data[, 7], mid.swing.data[, 2])
y <- rowMeans(most.common.cycle.matrix)
plot(x.p, -c(y[31:60], y[1:30]), type = "l", xlab = "Zeit ($\\% Doppelschritt$)", ylab = "Winkelgeschwindigkeit Z ($deg/s$)", ylim = c(-600, 600), xaxs = "i", col = rgb(229/255, 66/255, 66/255))
grid(col = rgb(186/255, 187/255, 194/255))
box()

dev.off()
      
```



  
```{r load-data, include=FALSE}

# Remove all variables
rm(list = ls(all = T))

# Set working directory
setwd("~/psychophysiopipeline/report")

# Load functions
source("./code-snippets/functions.r")

# Set paths
root.path <- "C:/Users/sbogutzky/Desktop/data (lokal)/2013/"

# Set variables
user <- "buse-patrick"
activity <- "laufen"

# Collect data
data.1 <- data.frame()
    
# Load FSS features
fss.feature.path <- paste(root.path, "features", "/", activity, "/", user, "/", "fss-features.csv", sep = "")
fss.features <- read.csv(fss.feature.path)
rm(fss.feature.path)
    
# Load HRV features
source("code-snippets/load-hrv-features.R")
    
# Load jerk cost features
source("code-snippets/load-jc-features.R")
    
# Load synchronization features
source("code-snippets/load-cls-features.R") 

# Set factors
subjects <- factor(fss.features$first.name, levels = c("Patrick"), labels = c("Male"))
measurements <- factor(fss.features$measurement, levels = c(1, 2, 3, 4), labels = c("15'", "30'", "45'", "60'"))
  
# Create data frame
data.1 <- rbind(data.1, data.frame(subject = subjects, session.start = factor(fss.features$session.start), measurement = measurements, fss.features[, c(1:8)], hrv.features[, c(3, 5)], cls.features[, 1:2], jc.features[, 1:2]))
rownames(data.1) <- seq(length = nrow(data.1))

data.2 <- data.1[-c(1, 5, 9, 13, 17, 21), ]

attach(data.2)

rm(user, activity, fss.features, hrv.features, cls.features, jc.features, subjects, measurements)
```

```{r check-day-effect-on-flow}
par(mfrow = c(2, 1))
hist(flow)
print(shapiro.test(flow))

boxplot(flow ~ session.start)

aov.1 <- aov(flow ~ session.start, data = data.1)
summary(aov.1)

levene(flow, session.start)
summary.lm(aov.1)

pairwise.t.test(flow, session.start, p.adj = "holm")
rm(aov.1)
```

```{r check-day-effect-on-fluency}
par(mfrow = c(2, 1))
hist(fluency)
print(shapiro.test(fluency))

boxplot(fluency ~ session.start)

aov.1 <- aov(fluency ~ session.start, data = data.1)
summary(aov.1)

levene(fluency, session.start)
summary.lm(aov.1)

pairwise.t.test(fluency, session.start, p.adj = "holm")
rm(aov.1)
```

```{r check-day-effect-on-absorption}
par(mfrow = c(2, 1))
hist(absorption)
print(shapiro.test(absorption))

boxplot(absorption ~ session.start)

aov.1 <- aov(absorption ~ session.start, data = data.1)
summary(aov.1)

levene(absorption, session.start)
summary.lm(aov.1)

pairwise.t.test(absorption, session.start, p.adj = "holm")
rm(aov.1)
```

```{r check-time-effect-on-flow}
par(mfrow = c(2, 1))
hist(flow)
print(shapiro.test(flow))

boxplot(flow ~ measurement)

aov.1 <- aov(flow ~ measurement, data = data.1)
summary(aov.1)

levene(flow, measurement)
summary.lm(aov.1)

pairwise.t.test(flow, measurement, p.adj = "holm")
rm(aov.1)
```

```{r check-time-effect-on-fluency}
par(mfrow = c(2, 1))
hist(fluency)
print(shapiro.test(fluency))

boxplot(fluency ~ measurement)

aov.1 <- aov(fluency ~ measurement, data = data.1)
summary(aov.1)

levene(fluency, measurement)
summary.lm(aov.1)

pairwise.t.test(fluency, measurement, p.adj = "holm")
rm(aov.1)
```

```{r check-time-effect-on-absorption}
par(mfrow = c(2, 1))
hist(absorption)
print(shapiro.test(absorption))

boxplot(absorption ~ measurement)

aov.1 <- aov(absorption ~ measurement, data = data.1)
summary(aov.1)

levene(absorption, measurement)
summary.lm(aov.1)

pairwise.t.test(absorption, measurement, p.adj = "holm")
rm(aov.1)
```

```{r plot}
par(mfrow = c(3, 2))

outlier <- c(1, 5, 9, 10, 11, 12, 13, 17, 21)

plot(mean.hr, flow, xlab = "Mean HR", ylab = "Flow", pch = 21, bg = "tomato")
PlotModels(mean.hr, flow)

plot(mean.hr, absorption, xlab = "Mean HR", ylab = "Absorption", pch = 21, bg = "tomato")
PlotModels(mean.hr, absorption)

plot(rmssd, flow, xlab = "RMSSD", ylab = "Flow", pch = 21, bg = "tomato")
PlotModels(rmssd, flow)

plot(rmssd, absorption, xlab = "RMSSD", ylab = "Absorption", pch = 21, bg = "tomato")
PlotModels(rmssd, absorption)

plot(mean.nsei, flow, xlab = "Mean Normalized Shannon Entropy Index", ylab = "Flow", pch = 21, bg = "darkolivegreen1") 
PlotModels(mean.nsei, flow)

plot(mean.nsei, absorption, xlab = "Mean Normalized Shannon Entropy Index", ylab = "Absorption", pch = 21, bg = "darkolivegreen1") 
PlotModels(mean.nsei, absorption)

par(mfrow = c(3, 2))

plot(mean.nsei, flow, xlab = "Mean Normalized Shannon Entropy Index", ylab = "Flow", pch = 21, bg = "darkolivegreen1") 
PlotModels(mean.nsei, flow)

plot(mean.nsei, fluency, xlab = "Mean Normalized Shannon Entropy Index", ylab = "Fluency", pch = 21, bg = "darkolivegreen1") 
PlotModels(mean.nsei, fluency)

plot(mean.cycle.interval, flow, xlab = "Mean Cycle Interval", ylab = "Flow", pch = 23, bg = "deepskyblue") 
PlotModels(mean.cycle.interval, flow)

plot(mean.cycle.interval, fluency, xlab = "Mean Cycle Interval", ylab = "Fluency", pch = 23, bg = "deepskyblue") 
PlotModels(mean.cycle.interval, fluency)

plot(mean.jerk.cost, flow, xlab = "Mean Jerk Cost", ylab = "Flow", pch = 23, bg = "deepskyblue") 
PlotModels(mean.jerk.cost, flow)

plot(mean.jerk.cost, fluency, xlab = "Mean Jerk Cost", ylab = "Fluency", pch = 23, bg = "deepskyblue") 
PlotModels(mean.jerk.cost, fluency)
```

```{r multilevel-model-for-flow}
require(lme4) 

random.intercept.model <- lmer(absorption ~ (1 | session.start), data = data.2, REML = FALSE)
null.model <- lm(absorption ~ 1, data = data.2)

random.intercept.model.log.lik <- as.numeric(logLik(random.intercept.model))
null.model.log.lik <- as.numeric(logLik(null.model))
lr <- 2 * (random.intercept.model.log.lik - null.model.log.lik)

print(paste("LR:", lr, "chi-squared distribution on 1 d.f.:", qchisq(.95, df = 1)))

mean.hr.2 <- mean.hr^2
random.intercept.model <- lmer(absorption ~ mean.hr + mean.hr.2 + (1 | measurement), data = data.2, REML = FALSE)
summary(random.intercept.model)

linear.model <- lm(absorption ~ mean.hr + mean.hr.2, data = data.2)
summary(linear.model)

random.intercept.model.log.lik <- as.numeric(logLik(random.intercept.model))
linear.model.log.lik <- as.numeric(logLik(linear.model))
lr <- 2 * (random.intercept.model.log.lik - linear.model.log.lik)

print(paste("LR:", lr, "chi-squared distribution on 1 d.f.:", qchisq(.95, df = 1)))

pred.flow <- fitted(random.intercept.model)

plot(mean.hr, pred.flow, xlab = "Mean HR", ylab = "Pred. Flow", pch = 21, bg = "tomato")


random.intercept.model <- lmer(absorption ~ mean.nsei + (1 | measurement), data = data.2, REML = FALSE)
summary(random.intercept.model)

linear.model <- lm(absorption ~ mean.nsei, data = data.2)
summary(linear.model)

random.intercept.model.log.lik <- as.numeric(logLik(random.intercept.model))
linear.model.log.lik <- as.numeric(logLik(linear.model))
lr <- 2 * (random.intercept.model.log.lik - linear.model.log.lik)

print(paste("LR:", lr, "chi-squared distribution on 1 d.f.:", qchisq(.95, df = 1)))

pred.flow <- fitted(random.intercept.model)

plot(mean.nsei, pred.flow, xlab = "Mean Normalized Shannon Entropy Index", ylab = "Pred. Flow", pch = 21, bg = "darkolivegreen1")
```



