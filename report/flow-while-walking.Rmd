---
title: "Flow beim Laufen (intraindividell)"
author: "Simon Bogutzky"
date: "27. Januar 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
```{r load-data, include=FALSE}
# Remove all variables
#rm(list = ls(all = T)) 

# Set root path
if(file.exists("/Volumes/flow/Documents/archiv/daten/2015/flow-gehen-und-laufen"))
  root.path <- "/Volumes/flow/Documents/archiv/daten/2015/flow-gehen-und-laufen/"

# Load functions
require(flow)

# Set test users
users <- c("grueter-barbara", "lochwitz-andreas", "worpenberg-annika")
activities <- c("walking")

# Collect data
data.1 <- data.frame()
for (activity in activities) {
  for (user in users) {
    
    # Load FSS features
    fss.feature.path <- paste(root.path, "features", "/", activity, "/", user, "/", "fss-features.csv", sep = "")
    fss.features <- read.csv(fss.feature.path)
    rm(fss.feature.path)
    
    # Load HRV features
    source("code-snippets/load-hrv-features.R")
    
    # Load JC features
    source("code-snippets/load-jc-features.R")
    
    # Load CLS features
    source("code-snippets/load-cls-features.R") 

    # Set factors
    subjects <- factor(fss.features$first.name)
    dates <- factor(strftime(as.POSIXct(fss.features$activity.start / 1000, origin = "1970-01-01", tz="CET"), format="%Y-%m-%d"))
    measurements <- factor(fss.features$measurement, levels = c(1, 2, 3, 4), labels = c("15'", "30'", "45'", "60'"))
  
    # Create data frame
    n.row <- nrow(fss.features)
    e.seq <- seq(3, n.row * 3, 3)
    data.1 <- rbind(data.1, data.frame(subject = subjects, date = dates, measurement = measurements, fss.features[, 1:5], hrv.features[e.seq, c(3:6, 11:12, 17:18, 24:25, 45:46)], jc.features[e.seq, 1:2], cls.features[e.seq, 1:2]))
    
  }
  rm(user, fss.features, hrv.features, jc.features, cls.features, n.row, e.seq, subjects, dates, measurements)
}
rownames(data.1) <- seq(length = nrow(data.1)) 
rm(activity)
```

```{r select-data, include=FALSE}
data.2 <- data.1[data.1$date == "2014-03-06" | data.1$date == "2014-05-27" | data.1$date == "2014-06-03" | data.1$date == "2014-06-04" |  data.1$date == "2014-06-16" | data.1$date == "2014-06-17" | data.1$date == "2014-06-18" | data.1$date == "2014-06-19" | data.1$date == "2014-07-23" | data.1$date == "2014-07-28" | data.1$date == "2014-07-29" | data.1$date == "2014-08-04", ]
```

```{r model-to-predict-baseline-absorption, include=FALSE}
data.3 <- data.1[c(1:28, 57:104), c(2, 3, 6)]
data.3$absorption[data.3$absorption == 0] <- NA
absorption.walking <- matrix(data = data.3$absorption, nrow = 19, byrow = T)
baseline.fss.features.barbara <- read.csv("/Volumes/flow/Documents/archiv/daten/2015/flow-gehen-und-laufen/features/baseline/grueter-barbara/fss-features.csv")
baseline.fss.features.andreas <- read.csv("/Volumes/flow/Documents/archiv/daten/2015/flow-gehen-und-laufen/features/baseline/lochwitz-andreas/fss-features.csv")
baseline.fss.features.annika <- read.csv("/Volumes/flow/Documents/archiv/daten/2015/flow-gehen-und-laufen/features/baseline/worpenberg-annika/fss-features.csv")
absorption.baseline <- c(baseline.fss.features.barbara$absorption, baseline.fss.features.andreas$absorption, baseline.fss.features.annika$absorption)
absorption.baseline[absorption.baseline == 0] <- NA

subject <- c(rep(1, 7), rep(2, 6), rep(3, 6))
plot(absorption.baseline ~ absorption.walking[, 1], col = subject)
mod.1 <- lm(absorption.baseline ~ absorption.walking[, 1])
summary(mod.1)
abline(mod.1)

mod.2 <- lm(absorption.baseline ~ absorption.walking[, 1] + absorption.walking[, 2] + absorption.walking[, 3] + absorption.walking[, 4])
summary(mod.2)
```

```{r distribution, echo=FALSE}
par("mfcol" = c(2, 3), mar = c(2.5, 2.5, 2.5, 3.5) + 0.1, mgp = c(1.5, .5, 0), las = 1, cex.axis = 0.8, tck = .03, cex.lab = .8, xaxs = "r", yaxs = "r")

for(i in unique(as.numeric(data.2$subject))) {
  data.2.1 <- data.2[as.numeric(data.2$subject) == i, ]
  hist(data.2.1$absorption, main = data.2.1$subject[1], xlab = "Absorption")
  print(shapiro.test(data.2.1$absorption))
  plot(data.2.1$absorption ~ data.2.1$measurement, xlab = "Measurement", ylab = "Absorption", pch = 21, bg = "#3FADCB")
}
rm(data.2.1, i)
```

```{r scale}
jerk.cost <- matrix(data = data.2$mean.jerk.cost, nrow = 3, byrow = T)
jerk.cost <- apply(jerk.cost, 1, scale)
data.2$mean.jerk.cost <- c(jerk.cost)
rm(jerk.cost)

# absorption <- matrix(data = data.2$absorption, nrow = 12, byrow = T)
# absorption <- apply(absorption, 1, scale)
# data.2$absorption <- c(absorption)
# rm(absorption)
```

```{r linear-regression}
for(i in unique(as.numeric(data.2$subject))) {
  data.2.1 <- data.2[as.numeric(data.2$subject) == i, ]
  par("mfcol" = c(1, 1), mar = c(3, 3, 2.5, 3.5) + 0.1, mgp = c(2, .5, 0), las = 1, cex.axis = 0.8, tck = .03, cex.lab = .8, xaxs = "r", yaxs = "r")
  plot(data.2.1$mean.jerk.cost ~ data.2.1$absorption, main = data.2.1$subject[1], xlab = "Absorption", ylab = "Jerk Cost", pch = 21, bg = "#3FADCB")
  mod <- lm(data.2.1$mean.jerk.cost ~ data.2.1$absorption)
  print(summary(mod))
  abline(mod)
  par("mfcol" = c(2, 2), mar = c(3, 3, 2.5, 3.5) + 0.1, mgp = c(2, .5, 0), las = 1, cex.axis = 0.8, tck = .03, cex.lab = .8, xaxs = "r", yaxs = "r")
  plot(mod)
}

fss.features$activity.start <- factor(strftime(as.POSIXct(fss.features$activity.start / 1000, origin = "1970-01-01", tz="CET"), format="%Y-%m-%d"))
```


```

```{r page-trend-test}
runs <- matrix(data.2$absorption, nrow = 24, byrow = T)
library(crank)
p.res <- page.trend.test(runs, F)
rm(runs, p.res)
```
